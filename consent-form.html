// This function receives the POST request from your form
function doPost(e) {
  // Check if the request body exists and is valid
  if (!e || !e.postData || !e.postData.contents) {
    return ContentService.createTextOutput(JSON.stringify({result: "error", message: "No POST data received"}))
      .setMimeType(ContentService.MimeType.JSON);
  }

  try {
    // Parse the JSON data sent from the form
    const data = JSON.parse(e.postData.contents);

    // The unique IDs for your Google Sheet and Drive folder
    // These have been replaced with the IDs you provided.
    const SHEET_ID = '1qIgVuOOKsl4fFCtD1zPWMxS76HXsB_k0cSvEqLtAEis';
    const FOLDER_ID = '1NORQfFqM2J6Speut6_zJEycVIs4Xcblw';

    // Extract the Base64 image data, timestamp, patient name, and consent status
    const base64Data = data.formImage.split(',')[1];
    const timestamp = data.timestamp;
    const patientName = data.patientName;
    const consentStatus = data.consent ? 'Y' : 'N';
    
    // Convert the Base64 string to a blob
    const blob = Utilities.newBlob(Utilities.base64Decode(base64Data), 'image/png', 'ConsentForm_' + patientName + '_' + timestamp + '.png');
    
    // Get the specific folder and save the image there
    const folder = DriveApp.getFolderById(FOLDER_ID);
    const file = folder.createFile(blob);
    const fileUrl = file.getUrl();
    
    // Log the form submission data to your Google Sheet, including the new file URL
    const sheet = SpreadsheetApp.openById(SHEET_ID).getSheets()[0];
    sheet.appendRow([new Date(), patientName, consentStatus, fileUrl]);

    // Return a successful response to the web page
    return ContentService.createTextOutput(JSON.stringify({result: "success", fileUrl: fileUrl}))
      .setMimeType(ContentService.MimeType.JSON);
  } catch (error) {
    // Handle any errors during processing
    return ContentService.createTextOutput(JSON.stringify({result: "error", message: error.message}))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

function doGet(e) {
  return ContentService.createTextOutput("Web App is running. Please submit data via POST.");
}
